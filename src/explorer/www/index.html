<!DOCTYPE html>
<html>
<head>
  <title>TVG Explorer</title>

  <script type="text/javascript" src="vis.min.js"></script>
  <link href="vis.min.css" rel="stylesheet" type="text/css" />

  <style type="text/css">
    #mynetwork {
      width: 100%;
      height: 800px;
      border: 1px solid lightgray;
    }
  </style>

  <script language="javascript" type="text/javascript">
    var nodes = new vis.DataSet([]);
    var edges = new vis.DataSet([]);
    var times = new vis.DataSet([]);
    var network;
    var timeline;

    function init()
    {
      // Initialize network
      var data = {nodes: nodes, edges: edges};

      var options = {
        nodes: {
          shape: 'dot',
          scaling: {
            min: 2,
            max: 30
          },
          font: {
            size: 16,
            face: 'Tahoma'
          }
        },
        edges: {
          color:{
            inherit: 'both'
          },
          // width: 0.15,
          smooth: {
            type: 'continuous'
          },
          scaling: {
            min: 2,
            max: 30
          },
        },
        interaction: {
          hideEdgesOnDrag: true,
          tooltipDelay: 200
        },
        physics: {
          stabilization: false,
          barnesHut: {
            gravitationalConstant: -10000,
            springConstant: 0.002,
            springLength: 150
          }
        },
      };

      var container = document.getElementById('mynetwork');
      network = new vis.Network(container, data, options);

      // Initialize timeline
      var options = {
//        showCurrentTime: true,
        start: new Date(Date.now() - 1000 * 60 * 60 * 24),
        end: new Date(Date.now() + 1000 * 60 * 60 * 24 * 6)
      };

      var container = document.getElementById('mytimeline');
      timeline = new vis.Timeline(container, times, options);
      timeline.addCustomTime(new Date(), 't1');
      timeline.on('timechanged', function (properties) {
        if (properties.id == 't1') {
          sendMessageJson({cmd: 'timeline_seek', time: properties.time.getTime()});
        }
      });
    }

    function doConnect()
    {
      websocket = new WebSocket("ws://localhost:8000/");
      websocket.onopen    = onOpen;
      websocket.onclose   = onClose;
      websocket.onmessage = onMessage;
      websocket.onerror   = onError;
    }

    function onOpen(evt)
    {
      console.log("connected\n");
      document.myform.connectButton.disabled = true;
    }

    function onClose(evt)
    {
      console.log("disconnected\n");
      document.myform.connectButton.disabled = false;
    }

    function onMessage(evt)
    {
      msg = JSON.parse(evt.data);

      switch (msg.cmd)
      {
        case "timeline_set_options":
          var options = {
            min: new Date(msg.min),
            max: new Date(msg.max),
          };
          timeline.setOptions(options);

          // Seek to the center of the given interval.
          current = new Date((msg.min + msg.max) / 2);
          timeline.setCustomTime(current, 't1');
          sendMessageJson({cmd: 'timeline_seek', time: current.getTime()});
          break;

        case "network_set":
          console.log("network_set:\n" +
                      "  " + msg.nodes.length + " nodes\n" +
                      "  " + msg.edges.length + " edges\n\n");

          nodes.clear();
          edges.clear();

          nodes.add(msg.nodes);
          edges.add(msg.edges);

          // FIXME: Stabilize?
          break;

        case "network_update":
          console.log("network_update:\n" +
                      "  " + msg.deleted_nodes.length + " deleted nodes\n" +
                      "  " + msg.deleted_edges.length + " deleted edges\n" +
                      "  " + msg.nodes.length + " nodes\n" +
                      "  " + msg.edges.length + " edges\n" +
                      "  mul = " + msg.mul + "\n\n");

          edges.remove(msg.deleted_edges);
          nodes.remove(msg.deleted_nodes);

          edges.forEach(function(edge)
          {
            edge.weight = edge.weight * msg.mul;
          });

          nodes.update(msg.nodes);
          edges.update(msg.edges);

          // FIXME: Stabilize?
          break;

        default:
          console.log("response: " + evt.data + '\n');
          break;
      }
    }

    function onError(evt)
    {
      console.log('error: ' + evt.data + '\n');

      websocket.close();

      document.myform.connectButton.disabled = false;
    }

    function sendMessageJson(message)
    {
      websocket.send(JSON.stringify(message))
    }

    window.addEventListener("load", init, false);
  </script>
</head>
<body>
  <div id="mynetwork"></div>
  <div id="mytimeline"></div>
  <form name="myform">
  <p>
  <input type="button" name=connectButton value="Connect" onClick="doConnect();">
  </p>
  </form>
</body>
</html>
